{{define "content"}}
<div class="page-header">
    <nav class="breadcrumb">
        <a href="/">Home</a>
        <span class="sep">‚Ä∫</span>
        <a href="/domain/{{.CurrentDomain.ID}}">{{.CurrentDomain.Name}}</a>
        <span class="sep">‚Ä∫</span>
        <a href="/domain/{{.CurrentDomain.ID}}/{{.Experiment.Level}}">Level {{.Experiment.Level}}</a>
        <span class="sep">‚Ä∫</span>
        <span>{{.Experiment.Name}}</span>
    </nav>
    <h1 class="page-title">
        <span class="title-icon" style="color: {{.CurrentDomain.Color}}">{{.CurrentDomain.Icon}}</span>
        {{.Experiment.Name}}
    </h1>
    <p class="page-description">{{.Experiment.Description}}</p>
    <div class="exp-badges">
        <span class="level-badge level-{{.Experiment.Level}}">Level {{.Experiment.Level}}</span>
        <span class="exp-status status-{{.Experiment.Status}}">{{.Experiment.Status}}</span>
        <span class="badge">{{.Experiment.Config.TrainMode}}</span>
        <span class="badge">{{.Experiment.Config.NumericType}}</span>
    </div>
</div>

<!-- Score Hero -->
<section class="section">
    <div class="score-hero glass">
        <div class="score-main">
            <span class="score-value">{{printf "%.0f" .Experiment.Results.Score}}</span>
            <span class="score-label">T.H.R.E.A.D. Score</span>
        </div>
        <div class="score-formula">
            = (Throughput √ó Stability √ó Consistency) / 100,000
        </div>
    </div>
</section>

<!-- Metrics Grid - All 6 Component Metrics -->
<section class="section">
    <h2 class="section-title">üìä T.H.R.E.A.D. Component Metrics</h2>

    <div class="metrics-detail-grid-6">
        <div class="metric-detail glass">
            <div class="metric-icon-sm">‚ö°</div>
            <div class="metric-value-lg">{{printf "%.2f" .Experiment.Results.ThroughputScore}}</div>
            <div class="metric-label">S<sub>tput</sub> (Throughput)</div>
            <div class="metric-formula-sm">log‚ÇÅ‚ÇÄ({{printf "%.0f" .Experiment.Results.ThroughputPerSec}})</div>
        </div>

        <div class="metric-detail glass">
            <div class="metric-icon-sm">‚öñÔ∏è</div>
            <div class="metric-value-lg">{{printf "%.0f" .Experiment.Results.Stability}}%</div>
            <div class="metric-label">I<sub>stab</sub> (Stability)</div>
            <div class="metric-formula-sm">max(0, 100 - œÉ<sub>acc</sub>)</div>
        </div>

        <div class="metric-detail glass">
            <div class="metric-icon-sm">‚úì</div>
            <div class="metric-value-lg">{{printf "%.0f" .Experiment.Results.Consistency}}%</div>
            <div class="metric-label">R<sub>cons</sub> (Consistency)</div>
            <div class="metric-formula-sm">Reliable windows / Total</div>
        </div>

        <div class="metric-detail glass">
            <div class="metric-icon-sm">üîÑ</div>
            <div class="metric-value-lg">{{printf "%.1f" .Experiment.Results.Plasticity}}</div>
            <div class="metric-label">Q<sub>plast</sub> (Plasticity)</div>
            <div class="metric-formula-sm">1000 / (recovery<sub>ms</sub> + Œµ)</div>
        </div>

        <div class="metric-detail glass">
            <div class="metric-icon-sm">üß†</div>
            <div class="metric-value-lg">{{printf "%+.1f" .Experiment.Results.MemoryDelta}}%</div>
            <div class="metric-label">Œî<sub>mem</sub> (Memory)</div>
            <div class="metric-formula-sm">Acc<sub>visit2</sub> - Acc<sub>visit1</sub></div>
        </div>

        <div class="metric-detail glass">
            <div class="metric-icon-sm">üéØ</div>
            <div class="metric-value-lg">{{printf "%.1f" .Experiment.Results.Precision}}%</div>
            <div class="metric-label">S<sub>prec</sub> (Precision)</div>
            <div class="metric-formula-sm">avg(100 - deviation)</div>
        </div>
    </div>

    <!-- Traditional metrics bar view -->
    <div class="metrics-bars-grid glass">
        <div class="metric-bar-item">
            <div class="metric-bar-header">
                <span>Average Accuracy</span>
                <span>{{printf "%.1f" .Experiment.Results.AvgAccuracy}}%</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill" style="width: {{printf " %.0f" .Experiment.Results.AvgAccuracy}}%"></div>
            </div>
        </div>
        <div class="metric-bar-item">
            <div class="metric-bar-header">
                <span>Stability Index</span>
                <span>{{printf "%.0f" .Experiment.Results.Stability}}%</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill success" style="width: {{printf " %.0f" .Experiment.Results.Stability}}%"></div>
            </div>
        </div>
        <div class="metric-bar-item">
            <div class="metric-bar-header">
                <span>Consistency Rate</span>
                <span>{{printf "%.0f" .Experiment.Results.Consistency}}%</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill info" style="width: {{printf " %.0f" .Experiment.Results.Consistency}}%"></div>
            </div>
        </div>
        <div class="metric-bar-item">
            <div class="metric-bar-header">
                <span>Precision Score</span>
                <span>{{printf "%.1f" .Experiment.Results.Precision}}%</span>
            </div>
            <div class="metric-bar">
                <div class="metric-fill warning" style="width: {{printf " %.0f" .Experiment.Results.Precision}}%"></div>
            </div>
        </div>
    </div>
</section>


<!-- Configuration -->
<section class="section">
    <h2 class="section-title">‚öôÔ∏è Configuration</h2>

    <div class="config-grid">
        <div class="config-card glass">
            <h3>Dataset</h3>
            <p class="config-value-lg">{{.Experiment.Dataset}}</p>
        </div>

        <div class="config-card glass">
            <h3>Training Mode</h3>
            <p class="config-value-lg">{{.Experiment.Config.TrainMode}}</p>
        </div>

        <div class="config-card glass">
            <h3>Numeric Type</h3>
            <p class="config-value-lg">{{.Experiment.Config.NumericType}}</p>
        </div>

        <div class="config-card glass">
            <h3>Batch Size</h3>
            <p class="config-value-lg">{{.Experiment.Config.BatchSize}}</p>
        </div>
    </div>

    <div class="layers-card glass">
        <h3>Network Architecture</h3>
        <div class="layers-flow">
            {{range $i, $layer := .Experiment.Config.Layers}}
            {{if $i}}<span class="layer-arrow">‚Üí</span>{{end}}
            <span class="layer-box">{{$layer}}</span>
            {{end}}
        </div>
    </div>
</section>

<!-- Charts -->
<section class="section">
    <h2 class="section-title">üìà Visualization</h2>

    <div class="charts-grid">
        <div class="chart-container-lg glass">
            <h3 class="chart-title">Accuracy Over Time</h3>
            <canvas id="timelineChart"></canvas>
        </div>

        <div class="chart-container glass">
            <h3 class="chart-title">Metrics Radar</h3>
            <canvas id="radarChart"></canvas>
        </div>

        <div class="chart-container glass">
            <h3 class="chart-title">Score Breakdown</h3>
            <canvas id="pieChart"></canvas>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Fetch experiment via API to avoid template issues with JSON
        fetch('/api/experiments/{{.Experiment.ID}}')
            .then(r => r.json())
            .then(exp => {
                // Set throughput bar width dynamically
                const throughputBar = document.getElementById('throughputBar');
                if (throughputBar) {
                    const pct = Math.min(100, (exp.results.throughputPerSec / 20000) * 100);
                    throughputBar.style.width = pct + '%';
                }

                // Timeline Chart
                const timelineCtx = document.getElementById('timelineChart');
                if (timelineCtx) {
                    const windows = exp.results.windows && exp.results.windows.length > 0
                        ? exp.results.windows
                        : Array.from({ length: 60 }, (_, i) => ({
                            timeMs: (i + 1) * 1000,
                            accuracy: exp.results.avgAccuracy + (Math.random() - 0.5) * 20
                        }));

                    new Chart(timelineCtx, {
                        type: 'line',
                        data: {
                            labels: windows.map(w => (w.timeMs / 1000) + 's'),
                            datasets: [{
                                label: 'Accuracy %',
                                data: windows.map(w => w.accuracy),
                                borderColor: '{{.CurrentDomain.Color}}',
                                backgroundColor: '{{.CurrentDomain.Color}}22',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: '#334155' },
                                    ticks: { color: '#94a3b8' }
                                },
                                x: {
                                    grid: { color: '#334155' },
                                    ticks: { color: '#94a3b8', maxTicksLimit: 12 }
                                }
                            }
                        }
                    });
                }

                // Radar Chart - All 6 T.H.R.E.A.D. Metrics
                const radarCtx = document.getElementById('radarChart');
                if (radarCtx) {
                    // Normalize all values to 0-100 scale for radar
                    const normalizedData = [
                        exp.results.throughputScore * 25,  // S_tput (0-4 ‚Üí 0-100)
                        exp.results.stability,              // I_stab (already 0-100)
                        exp.results.consistency,            // R_cons (already 0-100)
                        exp.results.plasticity * 10,        // Q_plast (0-10 ‚Üí 0-100)
                        Math.max(0, 50 + exp.results.memoryDelta * 2), // Œî_mem (-25 to +25 ‚Üí 0-100)
                        exp.results.precision               // S_prec (already 0-100)
                    ];

                    new Chart(radarCtx, {
                        type: 'radar',
                        data: {
                            labels: ['Throughput', 'Stability', 'Consistency', 'Plasticity', 'Memory', 'Precision'],
                            datasets: [{
                                label: exp.name,
                                data: normalizedData,
                                borderColor: '{{.CurrentDomain.Color}}',
                                backgroundColor: '{{.CurrentDomain.Color}}44',
                                borderWidth: 2,
                                pointBackgroundColor: '{{.CurrentDomain.Color}}',
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: '#334155' },
                                    ticks: { color: '#94a3b8', backdropColor: 'transparent', stepSize: 25 },
                                    pointLabels: { color: '#94a3b8', font: { size: 11 } }
                                }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }

                // Pie Chart - Score Composition (all 6 components)
                const pieCtx = document.getElementById('pieChart');
                if (pieCtx) {
                    new Chart(pieCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Throughput', 'Stability', 'Consistency', 'Plasticity', 'Memory', 'Precision'],
                            datasets: [{
                                data: [
                                    exp.results.throughputScore * 25,
                                    exp.results.stability,
                                    exp.results.consistency,
                                    exp.results.plasticity * 10,
                                    Math.abs(exp.results.memoryDelta) * 5,
                                    exp.results.precision
                                ],
                                backgroundColor: [
                                    '#3b82f6', // Throughput - Blue
                                    '#10b981', // Stability - Green
                                    '#8b5cf6', // Consistency - Purple
                                    '#f59e0b', // Plasticity - Amber
                                    '#ec4899', // Memory - Pink
                                    '#14b8a6'  // Precision - Teal
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { color: '#94a3b8', boxWidth: 12, padding: 8 } }
                            }
                        }
                    });
                }
            });
    });
</script>
{{end}}